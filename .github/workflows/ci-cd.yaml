name: CI/CD

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      run_validation_and_lint:
        description: 'Executar Validation & Code Quality'
        required: true
        default: true
        type: boolean
      run_build:
        description: 'Executar Build Maven'
        required: true
        default: true
        type: boolean
      run_unit_test:
        description: 'Executar Testes UnitÃ¡rios'
        required: true
        default: true
        type: boolean
      run_sonar_scan:
        description: 'Executar Sonar Scan'
        required: true
        default: true
        type: boolean
      run_docker_build_and_push:
        description: 'Executar Build e Push do Docker'
        required: true
        default: true
        type: boolean

jobs:
  load-config:
    name: Load Config
    runs-on: ubuntu-latest
    outputs:
      app_name: ${{ steps.load.outputs.app_name }}
      dockerhub_username: ${{ env.DOCKERHUB_USERNAME }}
      cluster_name: ${{ env.CLUSTER_NAME }}
      region_aws_deploy: ${{ env.REGION_AWS_DEPLOY }}
      domain_name: ${{ env.DOMAIN_NAME }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Load pipe.yml
        id: load
        run: |
          if [ ! -f pipe.yml ]; then
            echo "pipe.yml not found" >&2
            exit 1
          fi
          while IFS=':' read -r raw_key raw_value; do
            key=$(echo "$raw_key" | xargs | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_]/_/g')
            value=$(echo "$raw_value" | xargs)
            echo "${key}=${value}" >> "$GITHUB_ENV"
          done < pipe.yml

      - name: Set Default Values
        run: |
          echo "Setting default values for missing variables..."
          echo "APP_NAME=${{ env.APP_NAME || 'default-app' }}" >> $GITHUB_ENV
          echo "DOCKERHUB_USERNAME=${{ env.DOCKERHUB_USERNAME || 'postechf57' }}" >> $GITHUB_ENV
          echo "CLUSTER_NAME=${{ env.CLUSTER_NAME || 'eks-postech-g57' }}" >> $GITHUB_ENV
          echo "REGION_AWS_DEPLOY=${{ env.REGION_AWS_DEPLOY || 'us-east-1' }}" >> $GITHUB_ENV
          echo "DOMAIN_NAME=${{ env.DOMAIN_NAME || 'pos-tech-g57-food-app.com.br' }}" >> $GITHUB_ENV

      - name: Display Outputs
        run: |
          echo "App Name: ${{steps.load.outputs.app_name}}"
          echo "DockerHub Username: $DOCKERHUB_USERNAME"
          echo "Cluster Name: $CLUSTER_NAME"
          echo "Region AWS Deploy: $REGION_AWS_DEPLOY"
          echo "Domain Name: $DOMAIN_NAME"

  build-workflow:
    needs: load-config
    uses: rachelkozlowsky/nested-reusable-java-maven-eks/.github/workflows/build.yml@develop
    with:
      run_validation_and_lint: ${{ github.event.inputs.run_validation_and_lint }}
      run_build: ${{ github.event.inputs.run_build }}
      run_unit_test: ${{ github.event.inputs.run_unit_test }}
      app_name: ${{ needs.load-config.outputs.app_name }}
      dockerhub_username: ${{ needs.load-config.outputs.dockerhub_username }}
      cluster_name: ${{ needs.load-config.outputs.cluster_name }}
      region_aws_deploy: ${{ needs.load-config.outputs.region_aws_deploy }}
      domain_name: ${{ needs.load-config.outputs.domain_name }}

  gates-workflow:
    needs: load-config
    uses: rachelkozlowsky/nested-reusable-java-maven-eks/.github/workflows/gates.yml@develop
    with:
      run_sonar_scan: ${{ github.event.inputs.run_sonar_scan }}

  deploy-workflow:
    needs: load-config
    uses: rachelkozlowsky/nested-reusable-java-maven-eks/.github/workflows/deploy.yml@develop
    with:
      run_docker_build_and_push: ${{ github.event.inputs.run_docker_build_and_push }}
      run_deploy: ${{ github.event.inputs.run_deploy }}
      app_name: ${{ needs.load-config.outputs.app_name }}
      dockerhub_username: ${{ needs.load-config.outputs.dockerhub_username }}
      cluster_name: ${{ needs.load-config.outputs.cluster_name }}
      region_aws_deploy: ${{ needs.load-config.outputs.region_aws_deploy }}
      domain_name: ${{ needs.load-config.outputs.domain_name }}